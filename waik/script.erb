<%#
kind: script
name: WAIK default
oses:
- Windows Server 2008
- Windows Server 2008 R2
- Windows Server 2012
- Windows Server 2012 R2

# Parameters are expected to be set in Foreman (globally or per group/host)
params:
- netUser: username # username to access CIFS share
- netPassword: P@ssword # password to access to CIFS share
- netDriveLetter: Z # drive to mount CIFS while provisioning
- deploymentShare: 192.168.10.5 # Hostname/ip address of your CIFS deployment share
- foremanServer: 192.168.10.7 # Hostname/ip for your foreman server
- localAdminUser: Administrator # Username that will be used for local admin
- localAdminPassword: AdminPassword123 # Password that will be used for local admin
- windowsLicenseKey: ABCDE-ABCDE-ABCDE-ABCDE-ABCDE # Valid Windows license key
- windowsLicenseOwner: Company, INC # Legal owner of the Windows license key
%>

set netUser=<%= @host.params['netUser'] %>
set netPassword=<%= @host.params['netPassword'] %>
set netDriveLetter=<%= @host.params['netDriveLetter'] %>
set deploymentShare=<%= @host.params['deploymentShare'] %>
set foremanServer=<%= @host.params['foremanServer'] %>

echo Mounting network share
net use %netDriveLetter%: \\%deploymentShare%\install %netPassword% /USER:%netUser%

set DRIVERS=%netDriveLetter%:\drivers
 
<%= @host.diskLayout %>


::Write the install image to the partition
<% if @host.medium.path =~ /server-2008r2x64.standard/ -%>
  dism.exe /apply-image /imagefile:z:\server-2008r2\sources\install.wim /name:"Windows Server 2008 R2 SERVERSTANDARD" /ApplyDir:C:\
<% elsif @host.medium.path =~ /server-2008r2x64.enterprise/ -%>
  dism.exe /apply-image /imagefile:z:\server-2008r2\sources\install.wim /name:"Windows Server 2008 R2 SERVERENTERPRISE" /ApplyDir:C:\
<% elsif @host.medium.path =~ /server-2012r2x64.standard/ -%>
  dism.exe /apply-image /imagefile:z:\server-2012r2\sources\install.wim /name:"Windows Server 2012 R2 SERVERSTANDARD" /ApplyDir:C:\
<% end -%>        

 
::Set the proper boot sector
bootsect.exe /nt60 C:
C:\Windows\System32\bcdboot C:\Windows /l en-US
 
echo Stage the drivers locally to the system
xcopy /e /s %DRIVERS% c:\drivers\
 
echo Stage the Unattend.xml file for dism to apply
set myDIR=c:\Windows\Panther\
IF not exist %myDIR% (mkdir %myDIR%)

echo Downloading unattend.xml
x:\wimaging\deploy\wget.vbs <%= foreman_url("provision") -%> c:\Windows\Panther\unattend.xml



echo Creating a temp staging folder for DISM
mkdir c:\MININT\Scratch
 
echo Apply Unattend.xml
dism.exe /Image:C:\ /Apply-Unattend:c:\Windows\Panther\unattend.xml /ScratchDir:C:\MININT\Scratch/

::Apply Local.xml
::dism.exe /Image:C:\ /Apply-Unattend:x:\Windows\Local.xml /ScratchDir:C:\MININT\Scratch/
::del x:\Windows\Local.xml

echo Apply Drivers
::dism.exe /Image:C:\ /Add-Driver /Driver:%DRIVERS% /Recurse /ForceUnsigned
dism.exe /Image:C:\ /Add-Driver /Driver:c:\drivers\ /Recurse /ForceUnsigned

:: Enable PAUSE for debug:
::PAUSE
exit 0